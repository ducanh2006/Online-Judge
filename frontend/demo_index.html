<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Online Judge - SSE Test</title>
  <style>
    body { font-family: sans-serif; max-width: 700px; margin: 40px auto; }
    textarea { width: 100%; height: 150px; margin-top: 8px; }
    button { margin-top: 10px; padding: 10px 20px; }
    pre { background: #f4f4f4; padding: 10px; white-space: pre-wrap; border-radius: 6px; }
  </style>
</head>
<body>
  <h2>üéØ Online Judge Test Client</h2>

  <label>Problem ID:</label>
  <input type="number" id="problemId" placeholder="Nh·∫≠p ID b√†i to√°n" />

  <label>Gi·∫£i ph√°p c·ªßa b·∫°n:</label>
  <textarea id="solution" placeholder="D√°n code ho·∫∑c l·ªùi gi·∫£i v√†o ƒë√¢y..."></textarea>

  <button id="submitBtn">G·ª≠i b√†i v√† ch·∫•m ƒëi·ªÉm</button>

  <h3>K·∫øt qu·∫£:</h3>
  <pre id="output"></pre>

  <script>
    const JWT_TOKEN = "eyJhbGciOiJIUzM4NCJ9.eyJzdWIiOiJhbmgyIiwiaWQiOjIyLCJyb2xlIjoiTU9ERVJBVE9SIiwiaWF0IjoxNzY0NDA2MjY0LCJleHAiOjE3NjQ0OTI2NjR9.xTWv_x_r_-QPtAg6NNIxbzfCFggyjxZoPXZZ8twmwvfgSk_9JYfVFw2PQ1N2UyVM";
    const API_BASE = "http://localhost:8080/api/submissions";
    const output = document.getElementById("output");

    document.getElementById("submitBtn").onclick = async () => {
      output.textContent = "‚è≥ ƒêang g·ª≠i b√†i...";

      const problemId = document.getElementById("problemId").value;
      const yourSolution = document.getElementById("solution").value.trim();

      if (!problemId || !yourSolution) {
        alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß Problem ID v√† Solution!");
        return;
      }

      const createBody = { problemId: parseInt(problemId), yourSolution };

      try {
        const res = await fetch(API_BASE, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + JWT_TOKEN
          },
          body: JSON.stringify(createBody)
        });

        if (!res.ok) throw new Error("T·∫°o submission th·∫•t b·∫°i: " + res.status);

        const data = await res.json();
        const submissionId = data.submissionId;

        output.textContent = `‚úÖ Submission #${submissionId} t·∫°o th√†nh c√¥ng.\nƒêang b·∫Øt ƒë·∫ßu ch·∫•m...\n\n`;

        if (window.eventSource) window.eventSource.close();

        const type = 1; // 1 = ch·∫•m ƒëi·ªÉm
        const streamUrl = `${API_BASE}/stream?id=${submissionId}&type=${type}&token=${encodeURIComponent(JWT_TOKEN)}`;
        const eventSource = new EventSource(streamUrl);
        window.eventSource = eventSource;

        eventSource.onmessage = (event) => {
          output.textContent += event.data;
        };

        eventSource.addEventListener("complete", async (event) => {
          output.textContent += "\n\nüéâ Ho√†n th√†nh ch·∫•m ƒëi·ªÉm!";
          eventSource.close();

          // h·ªèi ng∆∞·ªùi d√πng c√≥ mu·ªën xem gi·∫£i th√≠ch kh√¥ng
          const wantExplanation = confirm("B·∫°n c√≥ mu·ªën xem gi·∫£i th√≠ch t·∫°i sao l·∫°i c√≥ s·ªë ƒëi·ªÉm n√†y kh√¥ng?");
          if (wantExplanation) {
            output.textContent += "\n\n‚è≥ ƒêang l·∫•y gi·∫£i th√≠ch...\n";
            const explainUrl = `${API_BASE}/stream?id=${submissionId}&type=2&token=${encodeURIComponent(JWT_TOKEN)}`;
            const explainSource = new EventSource(explainUrl);
            explainSource.onmessage = (e) => output.textContent += e.data;
            explainSource.addEventListener("complete", () => {
              output.textContent += "\n\n‚úÖ Ho√†n t·∫•t gi·∫£i th√≠ch!";
              explainSource.close();
            });
            explainSource.onerror = () => {
              output.textContent += "\n‚ùå L·ªói SSE khi l·∫•y gi·∫£i th√≠ch";
              explainSource.close();
            };
          }
        });

        eventSource.onerror = (event) => {
          output.textContent += "\n‚ùå L·ªói SSE";
          eventSource.close();
        };

      } catch (err) {
        output.textContent = "‚ùå L·ªói: " + err.message;
        console.error(err);
      }
    };
  </script>
</body>
</html>
